#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔨 Running build check before pushing..."

# Set up cleanup trap to ensure stash is restored even if script exits early
cleanup() {
  if [ "$STASH_NEEDED" = true ]; then
    echo "📦 Restoring stashed changes..."
    git stash pop
  fi
}

# Save the current state of the working directory
if git diff --quiet; then
  STASH_NEEDED=false
else
  STASH_NEEDED=true
  echo "📦 Stashing changes before build check..."
  git stash push -m "pre-push-build-check" --include-untracked
  
  # Set trap to restore stash on script exit (any reason)
  trap cleanup EXIT
fi

# Run the build process
echo "🏗️  Running build process..."
npm run build
BUILD_EXIT_CODE=$?

# If the build failed, prevent the push
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "❌ Build failed! Fix the build errors before pushing."
  exit 1
fi

echo "✅ Build successful! Proceeding with push..."
exit 0
